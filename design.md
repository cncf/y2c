# y2c

## Description

Automatically import events from Github repos into Google Calendar.

## Overview

[Probot](https://probot.github.io) (GitHub App) that reads event data from specific YAML files (`y2c.yml`) in a GitHub repo and calls the Google Calendar API to create/update events. Event attendees can either be individual's email addresses, Google Group email addresses or groups.io groups. Note that adding a new member to groups.io won't automatically trigger an invitation to the new member.

## Not in scope

* Managing members of the Google Groups. If members need to be added to the Google Group, this will need to happen via the Google Groups UI.
* Creating/Updating events on groups.io

## Format of event files (`y2c.yml`)

```yaml
id: 'calendar-id'                   # automatically generated by y2c
organizer: 'dan@linuxfoundation.com' # email address of the organizer
calendarId: 'calendar-id'           # Calendar Identifier (required by Google)
title: 'Event title'
description: 'Event Description'
start:
  date: '2020-02-10'                # Event start date
  time: '9:00am'                    # Event start time
  timeZone: 'America/New_York'
end:
  date: '2020-02-10'                # Event end date
  time: '11:00am'                   # Event end time
  timeZone: 'America/New_York'
attendees:
  - email: joe@example.com          # Guest email
    name: 'Joe User'                # Guest name (optional)
  - email: jane@example.com
    name: 'Jane User'
```

#### Notes
* The user will have to specify the Calendar Identifier where the event will be created. The organizer must have access to that calendar.
* Not sure we care about setting attendee names.
* The description will include a link to the zoom meeting.

## Adding Probot to a GitHub repo

The Probot will be added to organizations (CNCF and Kubernetes for now) on GitHub, which will grant access to all repos in that org.

## Authorizing requests to the Google Calendar API

The Google Calendar API uses OAuth 2.0. There are two possible approaches:

### Option 1 - [Using OAuth 2.0 for Web Server Applications](https://developers.google.com/identity/protocols/OAuth2WebServer)

This is the regular Oauth flow. With this approach after the Probot has been added to the GitHub organization we will require a super admin of the Google organization to go through the Oauth flow and authorize access to the calendars. We will store the Oauth token and make requests to manage events with that token.

The implications of this approach is that the super admin will be creating the events, so in the calendar UI it will show _created by super admin_ and any email invitations will be sent from the super admin's email address. If we want to be able to create events as different users, this approach is not an option.

Another downside of this approach is that the scope required to access a user's calendars is considered a sensitive scope and therefore we would need to submit the app for verification. Until verification is passed, anytime a super admin tries to go through the Oauth flow they will see a [_This app isn't verified_](https://support.google.com/cloud/answer/7454865) warning that they will have to dismiss. Also, there's a 100 new user limit for unverified apps, but I don't think we need to worry about this limit because that would mean 100 organizations have authorized the app. The verification process takes [3-5 days](https://support.google.com/cloud/answer/9110914)

### Option 2 - [OAuth 2.0 for Server to Server Applications](https://developers.google.com/identity/protocols/OAuth2ServiceAccount). 

With this approach we will generate a Service Account on Google and a super admin of the target organization will have to authorize the service account in their admin console. The steps they will have to follow to have everything set up are:

1. Google Admin goes to admin.google.com. Under `Security > Advanced Settings > Manage API Access` add new entry with the Client ID provided by us and scope `https://www.googleapis.com/auth/calendar`.
2. Install Probot on their GitHub organization.
3. After that we will need a super admin from Google to go through the Oauth flow so we will associate the GitHub org with the email address of the super admin. 

Step 3 is important because we want to prevent `Org1` on GitHub from adding events to `Org2` on Google Calendar. To do this we will first check that the super admin associated with a GitHub organization has access to the calendar in the `y2c.yml` file.

The benefits of this approach are that we will be able to set the creator of the event and any invitations will come from their email address.

### Comparison of the two options

| | Regular Oauth | Service Account |
| --- | :---: | :---: |
| Event Creator | Admin | Any user with right permissions on calendar|
| Emails sent from | Admin | Same as above |
| Google Requires App Verification | Yes | No |
| Needs to check permissions on calendars | No | Yes |
| Requires manual configuration by admins | No | Yes |
| Requires Oauth sign in on Google | Yes | Yes |

#### Notes 

In both cases we will be performing requests as the super admin, so if that super admin account's was closed or they changed their permissions, we would need another super admin to re-authorize the app.

#### Thoughts

Both approaches have pros and cons. If we want to go with the simplest we should go with the regular Oauth Flow. If we want to be able to set the event organizer and not need to go through verification we should use service accounts, at the expense of having a more complicated setup and needing to check permissions on calendars.

## Implementation of the Probot

At the higher level the Probot will:

* Receive webhook from Github repo and determine if it's a push on master that contains changes to `y2c.yml` files.
* For each `y2c.yml` file that changed check if the event data includes ID.
* If event data does not include ID:
    * Generate random ID.
    * Assign it to `y2c.yml` and commit file.
    * Create event on Google Calendar with the ID generated above.
* If event data includes ID, update event on Google Calendar.

## Deployment

`y2c` will be deployed on [Google App Engine](https://cloud.google.com/appengine/). A DB will be required to store Oauth tokens.
